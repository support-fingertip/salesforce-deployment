<template>
    <section class="slds-modal slds-fade-in-open slds-modal_large" role="dialog">
        <div class="slds-modal__container" style="max-width: 95%; width: 95%;">
            <header class="slds-modal__header">
                <h2 class="slds-text-heading_medium">Build Calculation Step</h2>
            </header>
            
            <div class="slds-modal__content slds-p-around_medium">
                
                <!-- Step Details -->
                <div class="slds-m-bottom_medium">
                    <lightning-input
                        label="Step Label"
                        value={localStep.stepLabel}
                        placeholder="e.g., Basic Price"
                        onchange={handleStepLabelChange}
                        required>
                    </lightning-input>
                    <div class="slds-text-color_weak slds-text-body_small slds-m-top_xx-small">
                        Variable name will be: <strong>{variableNamePreview}</strong>
                    </div>
                </div>

                <!-- Formula Builder - SIDE BY SIDE LAYOUT -->
                <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">Formula Builder</h3>
                    
                    <div class="slds-grid slds-gutters">
                        <!-- LEFT SIDE: Formula Builder Controls -->
                        <div class="slds-col slds-size_1-of-2">
                            <!-- Field Selection -->
                            <div class="slds-m-bottom_small">
                                <lightning-combobox
                                    label="Insert Field"
                                    placeholder="Select a field"
                                    options={availableFields}
                                    onchange={handleFieldSelect}>
                                </lightning-combobox>
                            </div>

                            <!-- Operators -->
                            <div class="slds-m-bottom_small">
                                <label class="slds-form-element__label slds-m-bottom_xx-small">Operators</label>
                                <div class="slds-button-group" role="group">
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value="+">+</button>
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value="-">−</button>
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value="*">×</button>
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value="/">÷</button>
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value="%">%</button>
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value="(">(</button>
                                    <button class="slds-button slds-button_neutral" onclick={handleOperatorClick} data-value=")">)</button>
                                </div>
                            </div>

                            <!-- Numbers -->
                            <div class="slds-m-bottom_small">
                                <label class="slds-form-element__label slds-m-bottom_xx-small">Fixed Values</label>
                                <div class="slds-grid slds-wrap">
                                    <template for:each={numberButtons} for:item="num">
                                        <div key={num} class="slds-col slds-size_1-of-4 slds-p-around_xx-small">
                                            <button class="slds-button slds-button_neutral slds-size_1-of-1" 
                                                    onclick={handleNumberClick} 
                                                    data-value={num}>{num}</button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Variables -->
                            <template if:true={hasExistingVariables}>
                                <div class="slds-m-bottom_small">
                                    <label class="slds-form-element__label slds-m-bottom_xx-small">Previous Step Variables</label>
                                    <div class="slds-button-group" role="group">
                                        <template for:each={existingVariables} for:item="variable">
                                            <button key={variable} 
                                                    class="slds-button slds-button_brand" 
                                                    onclick={handleVariableClick} 
                                                    data-value={variable}>{variable}</button>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Action Buttons -->
                            <div class="slds-m-top_small">
                                <lightning-button 
                                    label="Add IF Condition" 
                                    variant="neutral"
                                    onclick={handleToggleIfCondition}
                                    icon-name="utility:formula">
                                </lightning-button>
                                <lightning-button 
                                    label="Clear" 
                                    variant="destructive-text"
                                    onclick={handleClearFormula}
                                    class="slds-m-left_small">
                                </lightning-button>
                            </div>

                            <template if:true={showIfConditionBuilder}>
                        <div class="slds-box slds-theme_alert-texture slds-m-top_medium">
                            <h4 class="slds-text-heading_small slds-m-bottom_small">
                                <lightning-icon icon-name="utility:formula" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                                Build IF Condition
                            </h4>
                            
                            <!-- IF Condition -->
                            <div class="slds-grid slds-gutters slds-m-bottom_small">
                                <div class="slds-col slds-size_1-of-12">
                                    <label class="slds-form-element__label slds-m-top_small">IF</label>
                                </div>
                                <div class="slds-col slds-size_4-of-12">
                                    <lightning-combobox
                                        label="Left Value"
                                        value={ifCondition.leftValue}
                                        options={conditionFieldOptions}
                                        onchange={handleIfLeftChange}>
                                    </lightning-combobox>
                                </div>
                                <div class="slds-col slds-size_3-of-12">
                                    <lightning-combobox
                                        label="Operator"
                                        value={ifCondition.operator}
                                        options={comparisonOperators}
                                        onchange={handleIfOperatorChange}>
                                    </lightning-combobox>
                                </div>
                                <div class="slds-col slds-size_4-of-12">
                                    <!-- Show Picklist Dropdown if detected -->
                                    <template if:true={showPicklistForRight}>
                                        <lightning-combobox
                                            label="Right Value (Select)"
                                            value={ifCondition.rightValue}
                                            placeholder="Select value"
                                            options={picklistOptions}
                                            onchange={handleIfRightChange}>
                                        </lightning-combobox>
                                    </template>
                                    
                                    <!-- Show Input if not picklist -->
                                    <template if:false={showPicklistForRight}>
                                        <lightning-input
                                            label="Right Value"
                                            value={ifCondition.rightValue}
                                            placeholder="Enter number or field"
                                            onchange={handleIfRightChange}>
                                        </lightning-input>
                                    </template>
                                </div>
                            </div>

                            <!-- THEN -->
                            <div class="slds-grid slds-gutters slds-m-bottom_small">
                                <div class="slds-col slds-size_1-of-12">
                                    <label class="slds-form-element__label slds-m-top_small">THEN</label>
                                </div>
                                <div class="slds-col slds-size_11-of-12">
                                    <lightning-input
                                        label="Value if condition is true"
                                        value={ifCondition.trueValue}
                                        placeholder="Enter formula or select below"
                                        onchange={handleIfTrueChange}>
                                    </lightning-input>
                                    
                                </div>
                            </div>

                            <!-- ELSE -->
                            <div class="slds-grid slds-gutters slds-m-bottom_small">
                                <div class="slds-col slds-size_1-of-12">
                                    <label class="slds-form-element__label slds-m-top_small">ELSE</label>
                                </div>
                                <div class="slds-col slds-size_11-of-12">
                                    <lightning-input
                                        label="Value if condition is false"
                                        value={ifCondition.falseValue}
                                        placeholder="Enter formula or select below"
                                        onchange={handleIfFalseChange}>
                                    </lightning-input>
                                    
                                </div>
                            </div>

                            <!-- Preview -->
                            <div class="slds-m-bottom_small">
                                <label class="slds-form-element__label">IF Condition Preview:</label>
                                <div class="slds-box slds-theme_default">
                                    <code style="white-space: pre-wrap;">{ifConditionPreview}</code>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="slds-text-align_right">
                                <lightning-button 
                                    label="Cancel" 
                                    onclick={handleCancelIfCondition}
                                    class="slds-m-right_x-small">
                                </lightning-button>
                                <lightning-button 
                                    label="Insert IF Condition" 
                                    variant="brand"
                                    onclick={handleInsertIfCondition}>
                                </lightning-button>
                            </div>
                        </div>
                    </template>
                        </div>

                        <!-- RIGHT SIDE: Formula Preview -->
                        <div class="slds-col slds-size_1-of-2">
                            <label class="slds-form-element__label slds-m-bottom_xx-small">Formula Preview:</label>
                            <div class="slds-box slds-theme_default" style="min-height: 400px; padding: 1rem;">
                                <code style="white-space: pre-wrap; word-break: break-all;">{formulaPreview}</code>
                            </div>
                        </div>
                    </div>

                    <!-- IF Condition Builder - INLINE (Below Formula Builder) -->
                    
                </div>

                <!-- Storage Field -->
                <div class="slds-m-bottom_medium">
                    <lightning-combobox
                        label="Store Result in Target Field (optional)"
                        value={localStep.storeInField}
                        placeholder="Select field to store result"
                        options={bookingFields}
                        onchange={handleStoreFieldChange}>
                    </lightning-combobox>
                </div>

                <!-- Description -->
                <div>
                    <lightning-textarea
                        label="Description"
                        value={localStep.description}
                        placeholder="Describe what this step calculates"
                        onchange={handleDescriptionChange}>
                    </lightning-textarea>
                </div>

            </div>
            
            <footer class="slds-modal__footer">
                <lightning-button 
                    label="Cancel" 
                    onclick={handleCancel}>
                </lightning-button>
                <lightning-button 
                    label="Save Step" 
                    variant="brand"
                    onclick={handleSave}>
                </lightning-button>
            </footer>
        </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
</template>